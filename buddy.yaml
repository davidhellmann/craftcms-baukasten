- pipeline: "Build & Deploy to Production"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  ref_type: "BRANCH"
  target_site_url: "https://CHANGEME.com/"
  trigger_condition: "ALWAYS"
  actions:
    - action: "Execute: webpack build"
      type: "BUILD"
      working_directory: "/buddy/$PROJECT_SHORTNAME"
      docker_image_name: "nystudio107/webpack-dev-base"
      docker_image_tag: "latest"
      execute_commands:
        - "cd buildchain"
        - "npm ci"
        - "npm run build"
      volume_mappings:
        - "/:/buddy/$PROJECT_SHORTNAME"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "Execute: composer install"
      type: "BUILD"
      working_directory: "/buddy/$PROJECT_SHORTNAME"
      docker_image_name: "nystudio107/php-dev-base"
      docker_image_tag: "latest"
      execute_commands:
        - "cd cms"
        - "composer install --no-dev --no-progress --no-scripts --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs"
      setup_commands:
        - "echo \"memory_limit=-1\" >> /usr/local/etc/php/conf.d/buddy.ini"
        - "apt-get update && apt-get install -y git zip"
        - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
        - "# php ext pdo_mysql"
        - "docker-php-ext-install pdo_pgsql pgsql"
      volume_mappings:
        - "/:/buddy/$PROJECT_SHORTNAME"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "Rsync files to production"
      type: "RSYNC"
      local_path: "cms/"
      remote_path: "$REMOTE_PROJECT_ROOT/deploy-cache"
      login: "$REMOTE_SSH_USER"
      host: "$REMOTE_SSH_HOST"
      port: "22"
      authentication_mode: "WORKSPACE_KEY"
      archive: true
      delete_extra_files: true
      recursive: true
      compress: true
      deployment_excludes:
        - "/.git/"
      trigger_condition: "ALWAYS"
    - action: "Atomic deploy"
      type: "SSH_COMMAND"
      working_directory: "$REMOTE_PROJECT_ROOT"
      login: "$REMOTE_SSH_USER"
      host: "$REMOTE_SSH_HOST"
      port: "22"
      authentication_mode: "WORKSPACE_KEY"
      commands:
        - "if [ -d \"releases/$BUDDY_EXECUTION_REVISION\" ] && [ \"$BUDDY_EXECUTION_REFRESH\" = \"true\" ];"
        - "then"
        - " echo \"Removing: releases/$BUDDY_EXECUTION_REVISION\""
        - " rm -rf releases/$BUDDY_EXECUTION_REVISION;"
        - "fi"
        - "if [ ! -d \"releases/$BUDDY_EXECUTION_REVISION\" ];"
        - "then"
        - " echo \"Creating: releases/$BUDDY_EXECUTION_REVISION\""
        - " cp -dR deploy-cache releases/$BUDDY_EXECUTION_REVISION;"
        - "fi"
        - "echo \"Creating: persistent directories\""
        - "mkdir -p storage"
        - "echo \"Symlinking: persistent files & directories\""
        - "ln -nfs $REMOTE_PROJECT_ROOT/.env $REMOTE_PROJECT_ROOT/releases/$BUDDY_EXECUTION_REVISION"
        - "ln -nfs $REMOTE_PROJECT_ROOT/storage $REMOTE_PROJECT_ROOT/releases/$BUDDY_EXECUTION_REVISION"
        - "echo \"Linking current to revision: $BUDDY_EXECUTION_REVISION\""
        - "rm -f current"
        - "ln -s releases/$BUDDY_EXECUTION_REVISION current"
        - "echo \"Removing old releases\""
        - "cd releases && ls -t | tail -n +11 | xargs rm -rf"
      trigger_condition: "ALWAYS"
      run_as_script: true
      shell: "BASH"
    - action: "Prep Craft CMS"
      type: "SSH_COMMAND"
      working_directory: "$REMOTE_PROJECT_ROOT/current"
      login: "$REMOTE_SSH_USER"
      host: "$REMOTE_SSH_HOST"
      port: "22"
      authentication_mode: "WORKSPACE_KEY"
      commands:
        - "# Ensure the craft script is executable"
        - "chmod a+x craft"
        - "# Restart our long running queue listener process"
        - "echo \"\" | sudo -S supervisorctl restart all"
        - "# Backup the database just in case any migrations or Project Config changes have issues"
        - "php craft backup/db"
        - "# Run pending migrations, sync project config, and clear caches"
        - "php craft clear-caches/all"
        - "php craft migrate/all"
        - "php craft project-config/apply"
      trigger_condition: "ALWAYS"
      run_as_script: true
      shell: "BASH"
    - action: "Send notification to nystudio107 channel"
      type: "SLACK"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_EXECUTION_REVISION_SUBJECT - $BUDDY_EXECUTION_REVISION_COMMITTER_NAME"
      blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Successful execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
      channel: "G6AKRT78V"
      channel_name: "nystudio107"
      trigger_condition: "ALWAYS"
      integration_hash: "5ef0d26820cfeb531cb10738"
    - action: "Send notification to nystudio107 channel"
      type: "SLACK"
      trigger_time: "ON_FAILURE"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_EXECUTION_REVISION_SUBJECT - $BUDDY_EXECUTION_REVISION_COMMITTER_NAME"
      blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Failed execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
      channel: "G6AKRT78V"
      channel_name: "nystudio107"
      trigger_condition: "ALWAYS"
      integration_hash: "5ef0d26820cfeb531cb10738"
  variables:
    - key: "PROJECT_SHORTNAME"
      value: "CHANGEME"
    - key: "PROJECT_URL"
      value: "https://CHANGEME.com"
    - key: "REMOTE_PROJECT_ROOT"
      value: "/home/forge/CHANGEME"
    - key: "REMOTE_SSH_HOST"
      value: "CHANGEME.com"
    - key: "REMOTE_SSH_USER"
      value: "forge"
